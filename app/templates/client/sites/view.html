{% extends "base.html" %}

{% block title %}{{ site.name }} - Italia CDN Proxy Manager{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <div>
        <h1 class="text-3xl font-bold mb-2">{{ site.name }}</h1>
        <p class="text-gray-600">
            <span class="px-2 py-1 rounded-full text-xs {% if site.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                {{ 'Active' if site.is_active else 'Inactive' }}
            </span>
            <span class="ml-2 text-gray-600">Created on {{ site.created_at.strftime('%Y-%m-%d') }}</span>
        </p>
    </div>
    <div class="flex space-x-2">
        <a href="{{ url_for('client.edit_site', site_id=site.id) }}" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            Edit Site
        </a>
        <form method="POST" action="{{ url_for('client.toggle_site_active', site_id=site.id) }}">
            <button type="submit" class="px-4 py-2 {% if site.is_active %}bg-yellow-600{% else %}bg-green-600{% endif %} text-white rounded-md hover:{% if site.is_active %}bg-yellow-700{% else %}bg-green-700{% endif %} focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                {{ 'Deactivate' if site.is_active else 'Activate' }}
            </button>
        </form>
    </div>
</div>

<!-- Site Information -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Domain Information</h2>
        <dl>
            <div class="grid grid-cols-3 py-2 border-b">
                <dt class="font-medium text-gray-600">Domain:</dt>
                <dd class="col-span-2">{{ site.domain }}</dd>
            </div>
            <div class="grid grid-cols-3 py-2 border-b">
                <dt class="font-medium text-gray-600">Protocol:</dt>
                <dd class="col-span-2">{{ site.protocol | upper }}</dd>
            </div>
            <div class="grid grid-cols-3 py-2 border-b">
                <dt class="font-medium text-gray-600">Origin Server:</dt>
                <dd class="col-span-2">{{ site.origin_address }}:{{ site.origin_port }}</dd>
            </div>
            <div class="grid grid-cols-3 py-2 border-b">
                <dt class="font-medium text-gray-600">WAF Protection:</dt>
                <dd class="col-span-2">
                    <span class="px-2 py-0.5 rounded-full text-xs {% if site.use_waf %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ 'Enabled' if site.use_waf else 'Disabled' }}
                    </span>
                </dd>
            </div>
            <div class="grid grid-cols-3 py-2">
                <dt class="font-medium text-gray-600">Last Updated:</dt>
                <dd class="col-span-2">{{ site.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</dd>
            </div>
        </dl>
    </div>
    
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Deployment Status</h2>
        <div class="overflow-y-auto max-h-64">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="px-4 py-2 border">Node</th>
                        <th class="px-4 py-2 border">Status</th>
                        <th class="px-4 py-2 border">Last Deployed</th>
                    </tr>
                </thead>
                <tbody>
                    {% for site_node in site_nodes %}
                    <tr>
                        <td class="px-4 py-2 border">{{ site_node.node.name }}</td>
                        <td class="px-4 py-2 border">
                            <span class="px-2 py-1 rounded-full text-xs 
                            {% if site_node.status == 'deployed' %}bg-green-100 text-green-800
                            {% elif site_node.status == 'pending' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ site_node.status }}
                            </span>
                        </td>
                        <td class="px-4 py-2 border">
                            {% if site_node.deployed_at %}
                                {{ site_node.deployed_at.strftime('%Y-%m-%d %H:%M:%S') }}
                            {% else %}
                                Never
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- SSL Certificates -->
<div class="bg-white p-6 rounded-lg shadow-md mb-6">
    <h2 class="text-xl font-semibold mb-4">SSL Certificates</h2>
    
    {% if ssl_certificates %}
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-gray-100">
                    <th class="px-4 py-2 border">Domain</th>
                    <th class="px-4 py-2 border">Issuer</th>
                    <th class="px-4 py-2 border">Status</th>
                    <th class="px-4 py-2 border">Created</th>
                    <th class="px-4 py-2 border">Expires</th>
                </tr>
            </thead>
            <tbody>
                {% for cert in ssl_certificates %}
                <tr class="{% if cert.status == 'expired' %}bg-red-50{% endif %}">
                    <td class="px-4 py-2 border">{{ cert.domain }}</td>
                    <td class="px-4 py-2 border">{{ cert.issuer }}</td>
                    <td class="px-4 py-2 border">
                        <span class="px-2 py-1 rounded-full text-xs 
                        {% if cert.status == 'active' %}bg-green-100 text-green-800
                        {% elif cert.status == 'pending' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ cert.status }}
                        </span>
                    </td>
                    <td class="px-4 py-2 border">{{ cert.created_at.strftime('%Y-%m-%d') }}</td>
                    <td class="px-4 py-2 border">
                        {% if cert.expires_at %}
                            {{ cert.expires_at.strftime('%Y-%m-%d') }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-600">No SSL certificates have been issued for this site yet.</p>
    <p class="text-sm text-gray-500 mt-2">SSL certificates will be automatically requested when the site is deployed with HTTPS.</p>
    {% endif %}
</div>

<!-- Recent Deployment Logs -->
<div class="bg-white p-6 rounded-lg shadow-md mb-6">
    <h2 class="text-xl font-semibold mb-4">Recent Deployment Logs</h2>
    
    {% if deployment_logs %}
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-gray-100">
                    <th class="px-4 py-2 border">Time</th>
                    <th class="px-4 py-2 border">Node</th>
                    <th class="px-4 py-2 border">Action</th>
                    <th class="px-4 py-2 border">Status</th>
                    <th class="px-4 py-2 border">Message</th>
                </tr>
            </thead>
            <tbody>
                {% for log in deployment_logs %}
                <tr class="{% if log.status == 'error' %}bg-red-50{% endif %}">
                    <td class="px-4 py-2 border">{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td class="px-4 py-2 border">{{ log.node.name }}</td>
                    <td class="px-4 py-2 border">{{ log.action }}</td>
                    <td class="px-4 py-2 border">
                        <span class="px-2 py-1 rounded-full text-xs 
                        {% if log.status == 'success' %}bg-green-100 text-green-800
                        {% elif log.status == 'error' %}bg-red-100 text-red-800
                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                            {{ log.status }}
                        </span>
                    </td>
                    <td class="px-4 py-2 border">{{ log.message }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-gray-600">No deployment logs found for this site.</p>
    {% endif %}
</div>

<!-- Custom Configuration -->
{% if site.custom_config %}
<div class="bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-xl font-semibold mb-4">Custom Nginx Configuration</h2>
    <pre class="bg-gray-100 p-4 rounded-md overflow-x-auto"><code>{{ site.custom_config }}</code></pre>
</div>
{% endif %}
{% endblock %}