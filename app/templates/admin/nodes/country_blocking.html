{% extends "base.html" %}

{% block title %}Node Country Blocking - {{ node.name }} - Italia CDN Proxy Manager{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold mb-2">
                <i class="fas fa-globe me-2"></i>Global Country Blocking for {{ node.name }}
            </h1>
            <p class="text-muted">IP address: {{ node.ip_address }}</p>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="{{ url_for('admin.view_node', node_id=node.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Node
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12 mb-4">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Admin-Only Feature:</strong> Country blocking at the iptables level affects all traffic to this node, regardless of site. This is a global setting managed only by administrators.
            </div>
        </div>
    </div>

    <!-- GeoIP Module Status -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card border-{{ 'success' if geoip_status.fully_functional else 'warning' }}">
                <div class="card-header bg-{{ 'success' if geoip_status.fully_functional else 'warning' }} text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-{{ 'check-circle' if geoip_status.fully_functional else 'exclamation-triangle' }} me-2"></i>
                        GeoIP Module Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Module Loaded
                                    <span class="badge bg-{{ 'success' if geoip_status.module_loaded else 'danger' }} rounded-pill">
                                        <i class="fas fa-{{ 'check' if geoip_status.module_loaded else 'times' }}"></i>
                                    </span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Module Available
                                    <span class="badge bg-{{ 'success' if geoip_status.module_available else 'danger' }} rounded-pill">
                                        <i class="fas fa-{{ 'check' if geoip_status.module_available else 'times' }}"></i>
                                    </span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    GeoIP Database Installed
                                    <span class="badge bg-{{ 'success' if geoip_status.geoip_db_installed else 'danger' }} rounded-pill">
                                        <i class="fas fa-{{ 'check' if geoip_status.geoip_db_installed else 'times' }}"></i>
                                    </span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Ready for Country Blocking
                                    <span class="badge bg-{{ 'success' if geoip_status.fully_functional else 'danger' }} rounded-pill">
                                        <i class="fas fa-{{ 'check' if geoip_status.fully_functional else 'times' }}"></i>
                                    </span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            {% if not geoip_status.fully_functional %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>GeoIP module is not fully functional.</strong>
                                    {% if geoip_status.error %}
                                        <p class="mt-2 mb-0">Error: {{ geoip_status.error }}</p>
                                    {% endif %}
                                    <p class="mt-2 mb-0">You need to install the GeoIP module to use iptables-level country blocking.</p>
                                    <form method="POST" class="mt-3">
                                        <input type="hidden" name="action" value="install_geoip">
                                        <button type="submit" class="btn btn-warning">
                                            <i class="fas fa-download me-1"></i> Install GeoIP Module
                                        </button>
                                    </form>
                                </div>
                            {% else %}
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>GeoIP module is working properly.</strong>
                                    <p class="mt-2 mb-0">You can now block countries at the iptables level.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if geoip_status.fully_functional %}
    <div class="row">
        <!-- Currently Blocked Countries -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-ban me-2"></i>Currently Blocked Countries
                    </h5>
                </div>
                <div class="card-body">
                    {% if blocked_countries %}
                        <form method="POST">
                            <input type="hidden" name="action" value="unblock">
                            <div class="mb-3">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th style="width: 10%">Select</th>
                                                <th>Country Code</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for country in blocked_countries|sort %}
                                            <tr>
                                                <td>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="blocked_countries" value="{{ country }}" id="country_{{ country }}">
                                                    </div>
                                                </td>
                                                <td>
                                                    <label class="form-check-label w-100" for="country_{{ country }}">
                                                        {{ country }} 
                                                        {% if country|lower in country_names %}
                                                            - {{ country_names[country|lower] }}
                                                        {% endif %}
                                                    </label>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-unlock me-1"></i> Unblock Selected Countries
                            </button>
                        </form>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No countries are currently blocked at the iptables level.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Block New Countries -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Block New Countries
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="action" value="block">
                        <div class="mb-3">
                            <label for="countries" class="form-label">Country Codes (comma-separated)</label>
                            <input type="text" class="form-control" id="countries" name="countries" placeholder="US,CA,UK" required>
                            <div class="form-text">
                                Enter two-letter ISO country codes separated by commas (e.g., US,CA,UK).
                            </div>
                        </div>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-ban me-1"></i> Block Countries
                        </button>
                    </form>
                    
                    <div class="mt-4">
                        <div class="accordion" id="countryCodeAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                        <i class="fas fa-list me-2"></i> View Common Country Codes
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#countryCodeAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <ul class="list-group">
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        United States
                                                        <span class="badge bg-secondary">US</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Canada
                                                        <span class="badge bg-secondary">CA</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        United Kingdom
                                                        <span class="badge bg-secondary">GB</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Australia
                                                        <span class="badge bg-secondary">AU</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Germany
                                                        <span class="badge bg-secondary">DE</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        France
                                                        <span class="badge bg-secondary">FR</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Japan
                                                        <span class="badge bg-secondary">JP</span>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="col-md-6">
                                                <ul class="list-group">
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        China
                                                        <span class="badge bg-secondary">CN</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Russia
                                                        <span class="badge bg-secondary">RU</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        India
                                                        <span class="badge bg-secondary">IN</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Brazil
                                                        <span class="badge bg-secondary">BR</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Italy
                                                        <span class="badge bg-secondary">IT</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        Spain
                                                        <span class="badge bg-secondary">ES</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        South Korea
                                                        <span class="badge bg-secondary">KR</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Information and Help -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>Information About Country Blocking
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Important:</strong> This feature uses iptables with the GeoIP module to block traffic at the firewall level.
                    </div>
                    
                    <h5 class="mt-3">Key Points:</h5>
                    <ul>
                        <li><strong>Admin-Only Feature:</strong> Only administrators can configure iptables-level country blocking.</li>
                        <li><strong>Node-Level Blocking:</strong> This blocks traffic at the node level and applies to all sites hosted on this node.</li>
                        <li><strong>Higher Performance:</strong> Blocking at the iptables level is more efficient than using Nginx's GeoIP module.</li>
                        <li><strong>Global Effect:</strong> This will affect ALL sites on this node. For site-specific blocking, use the Nginx GeoIP option in site settings.</li>
                        <li><strong>Persistence:</strong> Rules are saved to persist across reboots.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add common country codes JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const commonCountryCodes = {
        'us': 'United States',
        'ca': 'Canada',
        'gb': 'United Kingdom',
        'au': 'Australia',
        'de': 'Germany',
        'fr': 'France',
        'jp': 'Japan',
        'cn': 'China',
        'ru': 'Russia',
        'in': 'India',
        'br': 'Brazil',
        'it': 'Italy',
        'es': 'Spain',
        'kr': 'South Korea',
        'nl': 'Netherlands',
        'se': 'Sweden',
        'no': 'Norway',
        'dk': 'Denmark',
        'fi': 'Finland',
        'pl': 'Poland',
        'ua': 'Ukraine',
        'mx': 'Mexico',
        'tr': 'Turkey',
        'sg': 'Singapore',
        'hk': 'Hong Kong',
        'za': 'South Africa',
        'eg': 'Egypt',
        'ng': 'Nigeria',
        'ar': 'Argentina',
        'cl': 'Chile'
    };
    
    // Populate the country names for the blocked countries table
    window.country_names = commonCountryCodes;
});
</script>
{% endblock %}